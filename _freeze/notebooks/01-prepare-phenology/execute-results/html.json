{
  "hash": "509bc0e29a7f7178512153a36d03d0c4",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Prepare data splits for calibration and validation\"\nauthor: Lars Caspersen\neditor: visual\n---\n\n\n\n\n\n\n\n\n\n\n## Aim\n\nThis notebook creates two versions of calibration / validation splits of the bloom observations: a \"full\" split using a common 75% calibration and 25% validation and a \"scarcity\" split with only ten observations per cultivar for calibration and the remaining data for validation.\n\nWe decided to have three cultivars per location. We only included phenology data from a single location even if there were observations from multiple locations to balance the experiment design.\n\nPrepare the cherry data\n\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.5.2     ✔ tibble    3.3.0\n✔ lubridate 1.9.4     ✔ tidyr     1.3.1\n✔ purrr     1.0.4     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(lubridate)\n#take three cultivars per location\ncherry <- read.csv('data/combined_phenological_data_adamedor_clean.csv') %>% \n  filter(species == 'Sweet Cherry') %>% \n  select(species, cultivar, location, flowering_f50, year) %>% \n  mutate(yday = lubridate::mdy(flowering_f50) %>% lubridate::yday()) %>% \n  na.omit()  \n\n\ncherry_summary <- cherry %>% \n  group_by(cultivar, location) %>% \n  summarise(n = n(),\n            mean = mean(yday)) %>% \n  filter(n >= 20)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n`summarise()` has grouped output by 'cultivar'. You can override using the\n`.groups` argument.\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#also take lapins from zaragoza\n\n#need to take burlat schneiders and regina from klein-altendorf\n#rainier, sam, van from zaragoza\n\ncherry_sub <- cherry %>% \n  filter(cultivar == 'Burlat' & location == 'Klein-Altendorf' |\n         cultivar == 'Regina' & location == 'Klein-Altendorf' |\n         cultivar == 'Schneiders' & location == 'Klein-Altendorf'|\n         cultivar == 'Rainier' & location == 'Zaragoza' |\n         cultivar == 'Van' & location == 'Zaragoza' |\n         cultivar == 'Sam' & location == 'Zaragoza')\n\n#sample for full and scarcity split\ncherry_master <- data.frame()\nshare_full<- 0.75\nn_scarce <- 10\n\nset.seed(12345667)\nfor(cult in unique(cherry_sub$cultivar)){\n  sub <- cherry_sub %>% \n    filter(cultivar == cult)\n  \n  i_cal_full <- sample(1:nrow(sub), size = floor(share_full*nrow(sub)))\n  i_cal_scarce <- sample(i_cal_full, size = 10)\n  \n  cherry_master <- cherry_master %>% \n    rbind(data.frame(sub[i_cal_full,],\n             split = 'Calibration',\n             ncal = 'full')) %>% \n    rbind(data.frame(sub[i_cal_scarce,],\n             split = 'Calibration',\n             ncal = 'scarce')) %>% \n    rbind(data.frame(sub[-i_cal_full,],\n             split = 'Validation',\n             ncal = 'full')) %>% \n    rbind(data.frame(sub[-i_cal_scarce,],\n             split = 'Validation',\n             ncal = 'scarce'))\n  \n}\n\nwrite.csv(cherry_master, 'data/master_cherry.csv', row.names = FALSE)\n```\n:::\n\n\n\n\n\n\n\n\n\n\nPrepare the apricot data\n\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#take three cultivars per location\napricot <- read.csv('data/combined_phenological_data_adamedor_clean.csv') %>% \n  filter(species == 'Apricot') %>% \n  select(species, cultivar, location, flowering_f50, year) %>% \n  mutate(yday = lubridate::mdy(flowering_f50) %>% lubridate::yday()) %>% \n  na.omit()  \n\n#sometimes R makes trouble with accents. So remove it from Bulida\napricot$cultivar <- ifelse(apricot$cultivar == \"B\\xfalida\",\n                           yes = 'Bulida',\n                           no = apricot$cultivar)\n\n\napricot_summary <- apricot %>% \n  group_by(cultivar, location) %>% \n  summarise(n = n(),\n            mean = mean(yday)) %>% \n  filter(n >= 20)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n`summarise()` has grouped output by 'cultivar'. You can override using the\n`.groups` argument.\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#select cultivars\napricot_sub <- apricot %>% \n  filter(cultivar == 'Bulida' & location == 'Cieza' |\n           cultivar == 'Dorada' & location == 'Cieza' |\n           cultivar == 'Goldrich' & location == 'Zaragoza'|\n           cultivar == 'Henderson' & location == 'Zaragoza' |\n           cultivar == 'Sunglo' & location == 'Zaragoza' |\n           cultivar == 'Harcot' & location == 'Zaragoza')\n\n#exclude one way too early observation of bulida\napricot_sub <- apricot_sub %>% \n  filter(yday > 44)\n\n# ggplot(apricot_sub, aes(x = yday, y = cultivar)) +\n#   geom_point() +\n#   facet_grid(~location)\n\nshare_full<- 0.75\nn_scarce <- 10\n\napricot_master <- data.frame()\n\nset.seed(12345667)\nfor(cult in unique(apricot_sub$cultivar)){\n  sub <- apricot_sub %>% \n    filter(cultivar == cult)\n  \n  i_cal_full <- sample(1:nrow(sub), size = floor(share_full*nrow(sub)))\n  i_cal_scarce <- sample(i_cal_full, size = 10)\n  \n  apricot_master <- apricot_master %>% \n    rbind(data.frame(sub[i_cal_full,],\n                     split = 'Calibration',\n                     ncal = 'full')) %>% \n    rbind(data.frame(sub[i_cal_scarce,],\n                     split = 'Calibration',\n                     ncal = 'scarce')) %>% \n    rbind(data.frame(sub[-i_cal_full,],\n                     split = 'Validation',\n                     ncal = 'full')) %>% \n    rbind(data.frame(sub[-i_cal_scarce,],\n                     split = 'Validation',\n                     ncal = 'scarce'))\n  \n}\n\nwrite.csv(apricot_master, 'data/master_apricot.csv', row.names = FALSE)\n```\n:::\n\n\n\n\n\n\n\n\n\n\nPrepare the almond data. In almond data I accidentally started first with the scarcity split, but in the end it has the same structure. Calibration data that is part of the scarcity split is also present in the calibration data of the \"full split\". I decided to keep this structure, so that the splits are reproducible.\n\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nalmond_adamedor <- read.csv('data/combined_phenological_data_adamedor_clean.csv') %>%\n  filter(species == 'Almond') %>% \n  select(species, cultivar, location, year, flowering_f50) %>%\n  drop_na() %>%\n  mutate(yday = lubridate::mdy(flowering_f50) %>% lubridate::yday())\n\noverview <- almond_adamedor %>%\n  mutate(cult_loc = paste(cultivar, location, sep ='-')) %>%\n  group_by(cult_loc, cultivar, location) %>%\n  summarise(n = n())\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n`summarise()` has grouped output by 'cult_loc', 'cultivar'. You can override\nusing the `.groups` argument.\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#keep it flexible so that I can do cross-validation if I want to\nrepetitions <- 1\nsample_size <- 10\ntraining_df <- data.frame()\nvalidation_df <- data.frame()\n\n#use all cultivars of meknes, santomera and the\n#cultivars mazzetto (late flowering, good performance),\n#garghzel (early flowering, good performance) and\n#fasciuneddu (normal flowering, inconsistent performance)\n\n# overview %>%\n#   filter(location %in% c('Meknes', 'Santomera')) %>%\n#   filter(n > 10)\n\n#achaak santomera, desmayo santomera, ferragnes meknes, ferragnes santomera, marcona meknes, marcona santomera,\n\ncult_loc_fit <-c('Achaak-Santomera', 'Desmayo-Santomera', 'Marta-Santomera',\n  'Marcona-Meknes', 'Ferragnes-Meknes', 'Tuono-Meknes',\n  'Nonpareil-Sfax', 'Fasciuneddu-Sfax', 'Mazzetto-Sfax')\n\noverview_sub <- overview %>%\n  filter(cult_loc %in% cult_loc_fit)\n\n\nfor(l in unique(overview_sub$cult_loc)){\n  #l <- overview_sub$cult_loc[1]\n\n  sub <- almond_adamedor %>%\n    mutate(cult_loc = paste(cultivar, location, sep ='-')) %>%\n    filter(cult_loc == l)\n\n  set.seed(123456789)\n  for(i in 1:repetitions){\n    sample_row <-sample(1:nrow(sub), size = sample_size)\n    sub_sub <- sub[sample_row,] %>%\n      mutate(r  = i)\n    sub_val <- sub[-sample_row,] %>%\n      mutate(r  = i)\n\n    training_df <- rbind(training_df, sub_sub)\n    validation_df <- rbind(validation_df, sub_val)\n  }\n}\n\n#--------------------#\n#\"full calibration####\n#--------------------#\nshare_train <- 0.75\n\ntrain_full <- data.frame()\nval_full <- data.frame()\n\n#take some of the validation data and put it in calibration\nfor(i in 1:repetitions){\n  for(cult in unique(training_df$cultivar)){\n    #i <- 1\n   # cult <- unique(training_df$cultivar)[2]\n    train_sub <- training_df %>% \n      filter(r == i,\n             cultivar == cult)\n    \n    val_sub <- validation_df %>% \n      filter(r == i,\n             cultivar == cult)\n    \n    n_train <- floor((nrow(train_sub) + nrow(val_sub))*share_train)\n    n_val <- nrow(train_sub) + nrow(val_sub) - n_train\n    \n    if(n_train <= nrow(train_sub)){\n      train_full <- rbind(train_full, train_sub)\n      val_full <- rbind(val_full, val_sub)\n    } else {\n      \n      #sample which validation goes to training\n      set.seed(123456789)\n      i_new_train <- sample(x = 1:nrow(val_sub), size = nrow(val_sub) - n_val)\n      train_sub <- train_sub %>% \n        rbind(val_sub[i_new_train,])\n      train_full <- rbind(train_full, train_sub)\n      val_full <- rbind(val_full, val_sub[-i_new_train,])\n    }\n    \n  }\n}\n\n#bring the datasets together in one master file\ntrain_full$split <- 'Calibration'\ntraining_df$split <- 'Calibration'\nvalidation_df$split <- 'Validation'\nval_full$split <- 'Validation'\n\ntrain_full$ncal <- 'full'\ntraining_df$ncal <- 'scarce'\nvalidation_df$ncal <- 'scarce'\nval_full$ncal <- 'full'\n\nalmond_master <- rbind(train_full,\n                       training_df) %>% \n  rbind(validation_df) %>% \n  rbind(val_full)\n\nwrite.csv(almond_master, 'data/master_almond.csv', row.names = FALSE)\n```\n:::\n",
    "supporting": [
      "01-prepare-phenology_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}